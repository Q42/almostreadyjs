<script src="../ready.js"/></script><script>

Game.title = 'Platformer'
Game.author = 'Martin Kool'
Game.path = '../files/images'

Screen.background = '#d0f4f7'

level = Level()
level.setTileSize(50, 50)
level.setTile('-', 'grassMid.png', { solid: true })
level.setTile('/', 'grassCenter.png', { solid: true })
level.setTile('!', 'boxItem.png', { solid: true })
level.setTile('%', 'castleCenter_rounded.png', { solid: true })
level.setTile('@', { images: ['spider_walk1.png', 'spider_walk2.png'], gravity: true, size: 30 })
level.setTile('X', { gravity: true, size: 65, z: 10 })
level.load(
'                ',
'                ',
'                ',
'      %%        ',
'  %             ',
'     %          ',
'@       %       ',
'%!%   %%%%%%%   ',
'                ',
'    %           ',
'         %      ',
'X % %!%         ',
'         %%     ',
'- @     %%% %   ',
'/---------- ----',
'/////////// ////',
'/////////// ////',
'/////////// ////',
'/              /',
'/              /',
'////////////////',
)
level.draw(0, Screen.bottom - 8 * 50)

player = level.getSprite('X')
enemies = level.getSpriteList('@')
for (nr=1; nr<10; nr++) player.images.push('p1_walk0' + nr + '.png')

on.keydown(function(e) {
  if (e.key == 'left' && player.left > 0) player.move(-3).set('flip', 1).nextImage(2)
  if (e.key == 'right' && player.right < level.sprites.right) player.move(3).set('flip', 0).nextImage(2)
})
on.keyup('left right', function(e) { player.image = 'p1_walk08.png' })
on.keypress('up', function(e) { player.jump(3) })

function platformer(e) {
  Screen.center(player)
  enemies.each(function(e) {
    if (!e.isDead) {
      e.move(2)
      e.nextImage(15)
      if (e.touchedSolid) e.turn()
    }
  })
  if (player.touches('left right', enemies)) die(player)
  var killedEnemy = player.touches('top', enemies);
  if (killedEnemy) die(killedEnemy);
}

repeat(platformer)

function die(sprite) {
  sprite.isDead = true;
  sprite.z = 2;
  sprite.pointTo(0).flipY = true;
  sprite.slideTo(sprite.x, sprite.y + 100, 0.4, function(e) { sprite.remove() })
}

</script>